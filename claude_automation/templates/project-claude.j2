# CLAUDE.md

> NixOS Configuration - Modern CLI Toolkit Optimization

## Tech Stack
- **OS**: NixOS 25.11 with Nix Flakes
- **Desktop**: GNOME (Wayland)
- **Shell**: Fish with Starship prompt
- **Terminal**: Kitty with JetBrains Mono Nerd Font
- **Package Manager**: Nix + Home Manager
- **Development**: DevEnv + Direnv for project environments

## Essential Commands

### System Management
- `./rebuild-nixos` - Interactive rebuild with safety checks (PREFERRED)
- `sudo nixos-rebuild switch --flake .` - Direct system rebuild
- `nix flake check` - Validate configuration syntax
- `nix develop` or `devenv shell` - Enter development environment

### AI Orchestration
- `./ai-orchestration/scripts/master-orchestrator.sh` - Master control system
- `claude-flow` or `npx claude-flow@alpha` - Enterprise AI coordination
- `ai filename.py` - Quick AI pair programming session
- `aicode src/*.py` - Pre-configured Claude Sonnet session

### Claude Code Sandboxing (Bubblewrap)
- `claude` - Normal interactive use (full access)
- `claude-sandboxed [project-dir]` - Kernel-level isolation with network (for autonomous tasks)
- `claude-airgapped [project-dir]` - Full isolation, no network (for code review)

Use `claude-sandboxed` when running with `--dangerously-skip-permissions` for long-running autonomous tasks. It provides:
- Process/IPC/UTS namespace isolation
- Filesystem restricted to project + ~/.claude only
- All Linux capabilities dropped
- Network access preserved for API calls

Use `claude-airgapped` for pure offline code review with zero network access.

## Project Structure
- `flake.nix` - Main configuration entry point
- `modules/core/packages.nix` - System-wide packages
- `modules/home-manager/` - User configs and shell setup
- `hosts/nixos/` - Hardware-specific configuration
- `basb-system/` - Building a Second Brain knowledge management
- `ai-orchestration/` - Multi-agent AI coordination system
- `stack-management/` - Technology stack lifecycle management

## Development Conventions

### Adding Packages
- **System tools**: Add to `modules/core/packages.nix`
- **User programs**: Add to `modules/home-manager/base.nix`
- **Project-specific**: Use `devenv.nix` or `shell.nix`

### Configuration Changes
- Always run `nix flake check` before rebuilding
- Use `./rebuild-nixos` for interactive safety checks
- Test with `nixos-rebuild test --flake .` first
- Keep modules focused on single responsibilities

### Code Style
- Follow existing Nix formatting conventions
- Use descriptive comments for complex configurations
- Group related packages logically
- Include URLs for package references when helpful

## Git Workflow

This repo uses a two-branch model with automatic syncing:

- **`personal`** - Primary working branch. All development happens here.
- **`master`** - Public-facing branch. Auto-synced by CI, sanitized of personal paths.

### Rules
- Always work on `personal` branch
- Commit and push to `personal` normally
- **NEVER manually merge personal ‚Üí master** (CI handles this automatically)
- The CI workflow `.github/workflows/sync-to-master.yml` syncs changes with sanitization

### Why no manual merge?
CI creates new commits on master (squashed, sanitized) with different hashes. Manual merges cause conflicts because the same content exists with different commit history.

## Do Not Touch
- `/etc/nixos/` (use this repo instead)
- `result` symlinks (Nix build artifacts)
- Files in `hosts/nixos/hardware-configuration.nix` (auto-generated)

## üìù User Memory & Notes
<!-- USER_MEMORY_START -->
<!-- This section preserves your personal notes and #memory entries across rebuilds -->
<!-- Add your content below this line -->

<!-- USER_MEMORY_END -->

---

## Dynamic Context

**MCP-NixOS** is configured in `.mcp.json` for real-time package/option queries.
Full analytics available in `.claude/tool-analytics.md` and `.claude/mcp-analytics.md`.
